pipeline {
    agent any

    environment {
        APP_NAME = "library-cunoc"
        JAR_NAME = "library_cunoc.jar"
        REPO_URL = "https://github.com/mromer08/test-jenkins.git"
        DEPLOY_PATH = "app/backend/target/" // Ruta en tu EC2
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: "main", credentialsId: "github_PAT", url: "${REPO_URL}"
            }
        }

        stage('Build Application') {
            steps {
                script {
                    sh """
                        echo "ðŸ”¹ Construyendo aplicaciÃ³n con Maven..."
                        cd app/backend
                        ./mvnw clean package -DskipTests
                    """
                }
            }
        }

stage('Deploy Application') {
    steps {
withCredentials([string(credentialsId: 'SUPER_SECRET', variable: 'SUPER_SECRET')]) {
    script {
        sh """
            echo "ðŸ”¹ Deteniendo proceso anterior..."
            pkill -f "${JAR_NAME}" || true

            echo "ðŸ”¹ Moviendo el nuevo JAR a ${DEPLOY_PATH}..."
            mv app/backend/target/*.jar ${DEPLOY_PATH}/${JAR_NAME}

            echo "ðŸš€ Iniciando la nueva versiÃ³n..."
        """  

        sh 'nohup java -jar $DEPLOY_PATH/$JAR_NAME > $DEPLOY_PATH/app.log 2>&1 &', 
            environment: [ "SUPER_SECRET=${SUPER_SECRET}" ]
    }
}

    }
}

    }
}
